<script lang="ts" setup>
import {
  NButton,
  NImage,
  NSpace,
  NTag,
  NTooltip,
  useDialog,
  useMessage,
} from 'naive-ui'
import { computed, ref } from 'vue'
import axios from 'axios'
import { fetchDownloadImg } from '@/api'
import type { ResData } from '@/api/types'
import failImg from '@/assets/fail.png'
import drawSvg from '@/assets/icons/draw.svg'
import zoomSvg from '@/assets/icons/zoom.svg'
import { useAppStore, useAuthStore } from '@/store'
import { fetchDrawTaskAPI } from '@/api/mjDraw'
import { SvgIcon } from '@/components/common'
import Loading from '@/components/base/Loading.vue'
import { app } from 'electron'

interface Emits {
  (e: 'usePrompt', val: any): void
  (e: 'queryData'): void
}

interface Props {
  drawItemInfo: any
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()
const appStore = useAppStore()
const authStore = useAuthStore()
const theme = computed(() => appStore.theme)
const loadingTextColor = computed(() =>
  theme.value === 'dark' ? '#fff' : '#000',
)
const dialog = useDialog()
const ms = useMessage()
const downloadUrl = `${import.meta.env.VITE_GLOB_API_URL}/midjourney/download`
const refreshLoading = ref(false)

const statusType: any = computed(() => {
  const { status } = props.drawItemInfo
  if (status === 1)
    return ''
  if (status === 2)
    return 'info'
  if (status === 3)
    return 'primary'
  if (status === 4)
    return 'error'
  if (status === 5)
    return 'error'
})
const statusMsg = computed(() => {
  const { status } = props.drawItemInfo
  if (status === 1)
    return appStore.getLanguage() == 'en-US' ? 'Waiting' : '等待中'
  if (status === 2)
    return appStore.getLanguage() == 'en-US' ? 'Drawing' : '绘制中'
  if (status === 3)
    return appStore.getLanguage() == 'en-US' ? 'Success' : '成功'
  if (status === 4)
    return appStore.getLanguage() == 'en-US' ? 'Fail' : '失败'
  if (status === 5)
    return appStore.getLanguage() == 'en-US' ? 'Time out' : '超时'
})

function usePrompt() {
  emit('usePrompt')
}

/* 下载图片 */
async function handleDownloadImg(item: any) {
  const d = dialog.info({
    title: appStore.getLanguage() == 'en-US' ? 'Download pictures' : '下载图片',
    content: appStore.getLanguage() == 'en-US' ? 'Are you sure to download the current picture?' : '是否确认下载当前图片',
    positiveText: appStore.getLanguage() == 'en-US' ? 'Download' : '下载',
    negativeText: appStore.getLanguage() == 'en-US' ? 'Cancel' : '取消',
    onPositiveClick: async () => {
      d.loading = true
      return new Promise(async (resolve) => {
        const { fileInfo } = item
        const { filename, cosUrl } = fileInfo
        const response = await axios.post(
          downloadUrl,
          { url: cosUrl },
          { responseType: 'blob' },
        )
        const blob = new Blob([response.data], {
          type: response.headers['content-type'],
        })
        const urlObject = window.URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = urlObject
        link.download = filename
        link.click()
        resolve(true)
      })
    },
  })
}

/* 删除图片 */
async function handleDeleteDraw(item: any) {
  dialog.warning({
    title: appStore.getLanguage() == 'en-US' ? 'Delete record' : '删除记录',
    content: appStore.getLanguage() == 'en-US' ? 'Are you sure to delete the current drawing record?' : '是否确认删除当前绘制记录？',
    positiveText: appStore.getLanguage() == 'en-US' ? 'Delete' : '删除',
    negativeText: appStore.getLanguage() == 'en-US' ? 'Cancel' : '取消',
    onPositiveClick: async () => {
      const { id } = item
      const res: ResData = await fetchDownloadImg({ id })
      if (!res.success)
        return ms.error(res.message)
      appStore.getLanguage() == 'en-US' ? ms.success('Deletion of drawing records successful!') : ms.success('删除绘制记录成功！')
      emit('queryData')
    },
  })
}

/* 提交放大绘制任务 */
async function handleUpscale(item: any, orderId: number) {
  const { drawId } = item
  await fetchDrawTaskAPI({ drawId, action: 'UPSCALE', orderId })
  appStore.getLanguage() == 'en-US' ? ms.success('The enlargement drawing task was submitted successfully, please wait for the drawing to end!') : ms.success('提交放大绘制任务成功、请等待绘制结束！')
  if (authStore.token)
    await refreshUserInfo()

  emit('queryData')
}

/* 提交重新生成任务 */
async function handleReGenerate(item: any, orderId: number) {
  const { drawId } = item
  await fetchDrawTaskAPI({ drawId, action: 'REGENERATE', orderId })
  appStore.getLanguage() == 'en-US' ? ms.success('The regeneration drawing task was submitted successfully, please wait for the drawing to end!') : ms.success('提交重新生成绘制任务成功、请等待绘制结束！')
  if (authStore.token)
    await refreshUserInfo()

  emit('queryData')
}

/* 提交变体任务 */
async function handleVariation(item: any, orderId: number) {
  const { drawId } = item
  await fetchDrawTaskAPI({ drawId, action: 'VARIATION', orderId })
  appStore.getLanguage() == 'en-US' ? ms.success('The image transformation drawing task was submitted successfully, please wait for the drawing to end!') : ms.success('提交图片变换绘制任务成功、请等待绘制结束！')
  if (authStore.token)
    await refreshUserInfo()

  emit('queryData')
}

async function refreshUserInfo() {
  refreshLoading.value = true
  try {
    await authStore.getUserInfo()
    refreshLoading.value = false
  }
  catch (error) {
    refreshLoading.value = false
  }
}

const calcTips = computed(() => {
  const { progress, status } = props.drawItemInfo
  if (status === 1)
    return appStore.getLanguage() == 'en-US' ? 'Queuing...' : '正在排队中...'
  if (status === 2 && !progress)
    return appStore.getLanguage() == 'en-US' ? 'Drawing...' : '正在绘制中...'
  if (status === 2 && progress === 100)
    return appStore.getLanguage() == 'en-US' ? 'Saving pictures...' : '正在存储图片中...'
})

/* 提交对单张图片调整任务 */
async function handleVary(item: any, orderId: number) {
  const { drawId } = item
  await fetchDrawTaskAPI({ drawId, action: 'VARIATION', orderId })
  appStore.getLanguage() == 'en-US' ? ms.success('The image adjustment drawing task was submitted successfully, please wait for the drawing to end!') : ms.success('提交图片调整绘制任务成功、请等待绘制结束！')
  if (authStore.token)
    await refreshUserInfo()

  emit('queryData')
}

/* 提交对单张图片缩放任务 */
async function handleZoom(item: any, orderId: number) {
  const { drawId } = item
  await fetchDrawTaskAPI({ drawId, action: 'UPSCALE', orderId })
  appStore.getLanguage() == 'en-US' ? ms.success('The image adjustment drawing task was submitted successfully, please wait for the drawing to end!') : ms.success('提交图片调整绘制任务成功、请等待绘制结束！')
  if (authStore.token)
    await refreshUserInfo()

  emit('queryData')
}

function handleRegion(file) {}
</script>

<template>
  <div
    class="border-2 border-black ronded-lg relative overflow-hidden rounded-md border p-4 transition-all hover:shadow dark:border-neutral-700"
  >
    <div class=" flex items-center justify-between">
      <span>
        <NTag size="small" :type="statusType">
          {{ statusMsg }}
        </NTag>
      </span>

      <NSpace>
        <NTooltip
          v-if="drawItemInfo.action === 'IMAGINE'"
          placement="top"
          trigger="hover"
        >
          <template #trigger>
            <NButton class="create" size="tiny" ghost @click="usePrompt">
              <template #icon>
                <SvgIcon icon="ri:brush-line" class="text-base" />
              </template>
              {{$t('common.use')}}
            </NButton>
          </template>
          <div style="width: 240px">
            <p>{{ drawItemInfo.fullPrompt }}</p>
          </div>
        </NTooltip>

        <NButton class="create" size="tiny" ghost @click="handleDownloadImg(drawItemInfo)">
          <template #icon>
            <SvgIcon icon="mingcute:file-download-line" class="text-base" />
          </template>
          {{ $t('common.download') }}
        </NButton>
        <NButton class="create" size="tiny" ghost @click="handleDeleteDraw(drawItemInfo)">
          <template #icon>
            <SvgIcon icon="ri:delete-bin-line" class="text-base" />
          </template>
          {{ $t('common.delete') }}
        </NButton>
      </NSpace>
    </div>
    <!-- content -->
    <div class="my-4 h-[280px]">
      <div
        v-if="drawItemInfo.status === 3"
        class="flex h-full w-full items-center justify-center overflow-hidden rounded-md"
      >
        <NImage
          style="object-fit: contain"
          :src="drawItemInfo.drawUrl"
          :preview-src="drawItemInfo.drawUrl"
          object-fit="contain"
        />
      </div>
      <div
        v-if="[4, 5, 6].includes(drawItemInfo.status)"
        class="flex flex-col h-full w-full items-center justify-center overflow-hidden rounded-md"
      >
        <img class="w-[75px]" :src="failImg">
        <span class="mt-3 text-base">{{ $t('cardItem.drawFailed') }}</span>
        <span class="mt-1">{{$t('cardItem.refundBalance')}}！</span>
      </div>
      <div
        v-if="[1, 2].includes(drawItemInfo.status)"
        class="my-4 h-[280px] relative"
      >
        <Loading
          :text-color="loadingTextColor"
          :progress="drawItemInfo.progress"
          :tips="calcTips"
        />
      </div>
    </div>
    <!-- footer -->
    <div class="-mx-4 -mb-4 bg-[#fafafc] px-4 py-2 dark:bg-[#262629]">
      <div
        v-if="
          (drawItemInfo.action === 'IMAGINE'
            || drawItemInfo.action === 'VARIATION'
            || drawItemInfo.action === 'ZOOM'
            || drawItemInfo.action === 'OUTPAINT'
            || drawItemInfo.action === 'REROLL')
            && drawItemInfo.status === 3
        "
        class="w-full"
      >
        <div class="mb-2 flex items-center justify-between">
          <span> {{$t('cardItem.enlarge')}}： </span>
          <span class="text-base text-neutral-400">
            <NTooltip placement="top" trigger="hover">
              <template #trigger>
                <SvgIcon icon="ri:error-warning-line" class="text-base" />
              </template>
              <div style="width: 240px">
                <p> {{ $t('cardItem.parameterExplain') }} </p>
              </div>
            </NTooltip>
          </span>
          <div class="flex-1">
            <div class="flex items-center justify-around">
              <NButton class="create" size="tiny" @click="handleUpscale(drawItemInfo, 1)">
                U1
              </NButton>
              <NButton class="create" size="tiny" @click="handleUpscale(drawItemInfo, 2)">
                U2
              </NButton>
              <NButton class="create" size="tiny" @click="handleUpscale(drawItemInfo, 3)">
                U3
              </NButton>
              <NButton class="create" size="tiny" @click="handleUpscale(drawItemInfo, 4)">
                U4
              </NButton>
              <NTooltip placement="top" trigger="hover">
                <template #trigger>
                  <NButton
                    class="create"
                    size="tiny"
                    @click="handleReGenerate(drawItemInfo, 5)"
                  >
                    <SvgIcon icon="solar:refresh-outline" class="text-base" />
                  </NButton>
                </template>
                <p>{{$t('cardItem.regen')}}</p>
              </NTooltip>
            </div>
          </div>
        </div>
      </div>

      <!-- 套图 新生成 变体图 重新生成 三种类型 -->
      <div
        v-if="
          (drawItemInfo.action === 'IMAGINE'
            || drawItemInfo.action === 'VARIATION'
            || drawItemInfo.action === 'ZOOM'
            || drawItemInfo.action === 'OUTPAINT'
            || drawItemInfo.action === 'REROLL')
            && drawItemInfo.status === 3
        "
        class="w-full"
      >
        <div class="mb-2 flex items-center justify-between">
          <span> {{$t('cardItem.transform')}}： </span>
          <span class="text-base text-neutral-400">
            <NTooltip placement="top" trigger="hover">
              <template #trigger>
                <SvgIcon icon="ri:error-warning-line" class="text-base" />
              </template>
              <div style="width: 240px">
                <p>
                  {{ $t('cardItem.parameterExplainRegen') }}
                </p>
              </div>
            </NTooltip>
          </span>
          <div class="flex-1">
            <div class="flex items-center justify-around">
              <NButton class="create" size="tiny" @click="handleVariation(drawItemInfo, 1)">
                V1
              </NButton>
              <NButton class="create" size="tiny" @click="handleVariation(drawItemInfo, 2)">
                V2
              </NButton>
              <NButton class="create" size="tiny" @click="handleVariation(drawItemInfo, 3)">
                V3
              </NButton>
              <NButton class="create" size="tiny" @click="handleVariation(drawItemInfo, 4)">
                V4
              </NButton>
              <NButton class="create" size="tiny" style="opacity: 0">
                V5
              </NButton>
            </div>
          </div>
        </div>
      </div>

      <!-- 对老图片增强 单张图或生成中的图 -->
      <div
        v-if="drawItemInfo.progress !== 100 && drawItemInfo.status !== 3"
        class="w-full mb-2 flex items-center justify-between"
      >
        <!-- 图片放大或变体 并且图片还未生成成功的时候没有message_id -->
        <div v-if="drawItemInfo.orderId !== 5">
          <span v-if="drawItemInfo.action === 'UPSCALE'">
            {{$t('common.action')}}：{{ `${$t('cardItem.selectSet')}${drawItemInfo.orderId || 'x'}${$t('cardItem.pictureEnlarge')}` }}
          </span>
          <span v-if="drawItemInfo.action === 'VARIATION'">
            {{$t('common.action')}}：{{ `${$t('cardItem.selectSet')}${drawItemInfo.orderId || 'x'}${$t('cardItem.pictureTransform')}` }}
          </span>
        </div>
        <!-- 已经生成成功的单张图 可以zoom和vary -->

        <!-- 重新绘制套图【只在生成中显示 生成完毕即会进入group套图】 -->
        <span v-if="drawItemInfo.orderId === 5">
          {{$t('common.action')}}: {{$t('cardItem.pictureRegen')}}
        </span>
      </div>

      <!-- 新图绘制中 -->
      <div
        v-if="
          drawItemInfo.action === 'IMAGINE'
            && !drawItemInfo.orderId
            && drawItemInfo.status === 'UPSCALE'
        "
        class="w-full mb-2 flex items-center justify-between"
      >
        {{$t('common.action')}}：{{$t('cardItem.drawingQuickly')}}...
      </div>

      <!-- 绘制失败了 -->
      <div
        v-if="!drawItemInfo.orderId && [4, 5, 6].includes(drawItemInfo.status)"
        class="w-full mb-2 flex items-center justify-between"
      >
        {{ $t('cardItem.tryAgain') }}
      </div>
      <!-- 加载失败 -->
      <div
        v-if="!drawItemInfo.action && !drawItemInfo.extend"
        class="w-full mb-2 flex items-center justify-between"
      >
        {{$t('cardItem.superior')}}： {{ drawItemInfo.message_id || $t('cardItem.loading') }}
      </div>

      <!-- 2 -->
      <div
        v-if="
          (drawItemInfo.action === 'UPSCALE'
            || drawItemInfo.action === 'ACTION')
            && drawItemInfo.status === 3
        "
      >
        <div class="mb-2 flex flex-1 items-center justify-between">
          <span>{{$t('cardItem.loading')}}：</span>
          <span class="text-base text-neutral-400">
            <NTooltip placement="top" trigger="hover">
              <template #trigger>
                <SvgIcon icon="ri:error-warning-line" class="text-base" />
              </template>
              <div style="width: 270px">
                <p>{{ $t('cardItem.parameterExplainZoom') }}</p>
              </div>
            </NTooltip>
          </span>
          <div class="flex-1">
            <div class="flex items-center pl-2">
              <NSpace>
                <NTooltip placement="top" trigger="hover">
                  <template #trigger>
                    <NButton size="tiny" @click="handleZoom(drawItemInfo, 1)">
                      <template #icon>
                        <img :src="zoomSvg" class="w-4" alt="">
                      </template>
                      U(Subtle)
                    </NButton>
                  </template>
                  <p>{{ $t('cardItem.enlarge') }}</p>
                </NTooltip>

                <NTooltip placement="top" trigger="hover">
                  <template #trigger>
                    <NButton size="tiny" @click="handleZoom(drawItemInfo, 2)">
                      <template #icon>
                        <img :src="zoomSvg" class="w-4" alt="">
                      </template>
                      U(Creative)
                    </NButton>
                  </template>
                  <p>{{ $t('cardItem.enlarge') }}</p>
                </NTooltip>
              </NSpace>
            </div>
          </div>
        </div>
      </div>
      <div
        v-if="
          (drawItemInfo.action === 'UPSCALE'
            || drawItemInfo.action === 'ACTION')
            && drawItemInfo.status === 3
        "
        class="flex w-full"
      >
        <div class="mb-2 flex flex-1 items-center justify-between">
          <span>{{$t('cardItem.adjust')}}：</span>
          <span class="text-base text-neutral-400">
            <NTooltip placement="top" trigger="hover">
              <template #trigger>
                <SvgIcon icon="ri:error-warning-line" class="text-base" />
              </template>
              <div style="width: 275px">
                <p>{{ $t('cardItem.parameterExplainAdjust') }}</p>
              </div>
            </NTooltip>
          </span>
          <div class="flex-1">
            <div class="flex items-center pl-2">
              <NSpace>
                <NTooltip placement="top" trigger="hover">
                  <template #trigger>
                    <NButton size="tiny" @click="handleVary(drawItemInfo, 1)">
                      <template #icon>
                        <img :src="drawSvg" class="w-4" alt="">
                      </template>
                      V(Strong)
                    </NButton>
                  </template>
                  <p>{{ $t('cardItem.enhancedInfo') }}</p>
                </NTooltip>

                <NTooltip placement="top" trigger="hover">
                  <template #trigger>
                    <NButton size="tiny" @click="handleVary(drawItemInfo, 2)">
                      <template #icon>
                        <img :src="drawSvg" class="w-4" alt="">
                      </template>
                      V(Subtle)
                    </NButton>
                  </template>
                  <p>{{ $t('cardItem.adjustInfo') }}</p>
                </NTooltip>
              </NSpace>
            </div>
          </div>
        </div>
      </div>

      <!-- <div class="w-full flex">
        <span class="text-[#64748b]">时间：{{ drawItemInfo.createdAt }}</span>
      </div> -->
    </div>
  </div>
</template>

<style lang="scss" scoped>
* {
    font-family: 'DM Sans', sans-serif; /* 设置全局字体为 DM Sans */
}
.create{
  font-weight: bold;
  border: 2px solid black; /* 黑色边框 */
  border-radius: 6rem; /* 圆角 */
  color: black; /* 字体颜色 */
  background-color: #27E093; /* 按钮背景颜色为绿色 */
  transition: background-color 0.3s; /* 背景色过渡效果 */
}
.create:hover{
  background-color: #27E093!important; /* 悬停时的更深绿色 */
  border-bottom: 6px solid #000000; /* 添加加粗的底边 */
  color:#000000!important; /* 字体颜色 */
}
</style>
